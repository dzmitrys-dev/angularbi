<div class="container">
  <h2>CSV LLM Processor</h2>
  
  <!-- Upload CSV -->
  <div class="upload-section">
    <label for="csvFile">Upload CSV:</label>
    <input 
      #csvInput
      type="file" 
      id="csvFile" 
      accept=".csv" 
      (change)="onFileSelected($event)"
      [disabled]="isProcessing()"
    />
    @if (csvFile()) {
      <span class="file-name">{{ csvFile()?.name }}</span>
    }
  </div>

  <!-- Global Dataset Prompt -->
  <div class="global-prompt-section">
    <label for="global-prompt">Dataset Analysis Prompt (use &#123;data&#125; for all CSV rows):</label>
    <textarea
      id="global-prompt"
      [ngModel]="globalPrompt()"
      (ngModelChange)="globalPrompt.set($event)"
      placeholder="e.g., What is the total price of all products? Data: &#123;data&#125;"
      rows="2"
      [disabled]="isProcessing()"
    ></textarea>
    <button
      (click)="processGlobalPrompt()"
      [disabled]="!hasData() || !globalPrompt() || isProcessing()"
      class="global-process-btn"
    >
      Analyze Dataset
    </button>
  </div>

  <!-- Row-level Prompt Template -->
  <div class="prompt-section">
    <label for="row-prompt">Row Analysis Prompt (use &#123;line&#125; for CSV row):</label>
    <textarea
      id="row-prompt"
      [ngModel]="promptTemplate()"
      (ngModelChange)="promptTemplate.set($event)"
      placeholder="e.g., Summarize this data: &#123;line&#125;"
      rows="2"
      [disabled]="isProcessing()"
    ></textarea>
  </div>

  <!-- Controls -->
  <div class="controls">
    <button
      (click)="processCsv()"
      [disabled]="!hasData() || !promptTemplate() || isProcessing()"
      class="process-btn"
    >
      @if (isProcessing()) {
        Processing...
      } @else {
        Process with LLM
      }
    </button>
    @if (isProcessing()) {
      <button (click)="stopProcessing()" class="stop-btn">Stop Processing</button>
    }
    <button (click)="clearData()" [disabled]="isProcessing()" class="clear-btn">Clear</button>
  </div>

  <!-- Engine Loading Progress -->
  @if (loadingProgress()) {
    <div class="progress-section">
      <h3>LLM Engine Loading...</h3>
      <div class="progress-bar">
        <div 
          class="progress-fill" 
          [style.width.%]="loadingProgress()!.progress * 100"
        ></div>
      </div>
      <p>{{ loadingProgress()!.text }}</p>
    </div>
  }

  <!-- Processing Progress -->
  @if (isProcessing()) {
    <div class="progress-section">
      <h3>Processing CSV rows...</h3>
      <div class="progress-bar">
        <div 
          class="progress-fill" 
          [style.width.%]="processingProgress()"
        ></div>
      </div>
      <p>{{ processingProgress() | number:'1.0-0' }}%</p>
    </div>
  }

  <!-- Error -->
  @if (error()) {
    <div class="error">{{ error() }}</div>
  }

  <!-- Global Result -->
  @if (globalResult()) {
    <div class="global-result-section">
      <h3>Dataset Analysis Result</h3>
      <div class="global-result-content">{{ globalResult() }}</div>
    </div>
  }

  <!-- Results Table -->
  @if (hasData()) {
    <div class="table-section">
      <h3>Row Results ({{ csvData().length }} rows)</h3>
      <table>
        <thead>
          <tr>
            @for (header of headers(); track header) {
              <th>{{ header }}</th>
            }
            <th>LLM Result</th>
          </tr>
        </thead>
        <tbody>
          @for (row of csvData(); track $index) {
            <tr>
              @for (header of headers(); track header) {
                <td>{{ row[header] }}</td>
              }
              <td>{{ getResult($index) }}</td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }
</div>